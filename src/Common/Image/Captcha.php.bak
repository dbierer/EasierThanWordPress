<?php
namespace Common\Image;
/**
 * Creates a CAPTCHA
 */
use RecursiveDirectoryIterator;
use RecursiveIteratorIterator;
use Common\Image\SingleChar;
use Common\Image\Strategy\ {LineFill,DotFill,Shadow,RotateText};
class Captcha
{
	const NUM_BYTES = 2;
	const FONT_FILE = SRC_DIR . '/fonts/FreeSansBold.ttf';
	const IMG_DIR   = BASE_DIR . '/public/img/captcha';
	public $token   = '';
	public $phrase  = '';
	public $images  = [];
	public $config  = [];
	public $imgDir   = '';
	public $fontFile = '';
	public $numBytes = 0;
	public $strategies = ['rotate', 'line', 'line', 'dot', 'dot', 'shadow'];
	/**
	 * @param array $config : CAPTCHA config
	 */
	public function __construct(array $config = NULL)
	{
		$this->config = $config;
		$this->imgDir = $config['img_dir'] ?? self::IMG_DIR;
		$this->fontFile = $config['font_file'] ?? self::FONT_FILE;
		$this->numBytes = $config['num_bytes'] ?? self::NUM_BYTES;
	}
	/**
	 * Writes out NUM_BYTES * 2 CAPTCHA images
	 *
	 * @param string $token : used to identify this user
	 * @return array $images : filenames of CAPTCHA images produced
	 */
	public function writeImages(string $token)
	{
		// generate random hex number for CAPTCHA
		$phrase = strtoupper(bin2hex(random_bytes($this->numBytes)));
		$length = strlen($phrase);
		$images = [];
		for ($x = 0; $x < $length; $x++) {
			$char = new SingleChar($phrase[$x], $this->fontFile);
			$char->writeFill();
			shuffle($this->strategies);
			foreach ($this->strategies as $item) {
				switch ($item) {
					case 'rotate' :
						RotateText::writeText($char, -25, 25);
						break;
					case 'line' :
						$num = rand(1, 20);
						LineFill::writeFill($char, $num);
						break;
					case 'dot' :
						$num = rand(10, 40);
						DotFill::writeFill($char, $num);
						break;
					case 'shadow' :
						$num = rand(1, 8);
						$red = rand(0x70, 0xEF);
						$green = rand(0x70, 0xEF);
						$blue = rand(0x70, 0xEF);
						Shadow::writeText($char, $num, $red, $green, $blue);
						break;
					default :
						// do nothing
				}
			}
			$char->writeText();
			$fn = $x . '_' . $token . '.png';
			$success = $char->save($this->imgDir . '/' . $fn);
			$this->images[] = $fn;
			error_log(__METHOD__ . ':' . var_export(get_object_vars($this), TRUE));
		}
		$this->phrase = $phrase;
		return $this->images;
	}
	/**
	 * Erase images older than 1 day
	 */
	public function __destruct()
	{
		$iter = new \RecursiveDirectoryIterator($this->imgDir);
		$now = time();
		$yesterday = $now - (60 * 60 * 24);
		foreach ($iter as $name => $obj) {
			// find files older than 24 hours
			if ($obj->isFile() && $obj->getCTime() > $yesterday) {
				unlink($name);
			}
		}
	}
}
